<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js"></script>
  <title>RSA Digital Signature</title>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <nav class="bg-blue-600 text-white px-4 py-3">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-xl font-bold">RSA Digital Signature</h1>
      <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded">Logout</button>
    </div>
  </nav>
  <main class="flex-grow container mx-auto px-4 py-6">
    <div id="app"></div>
  </main>
  <footer class="bg-blue-600 text-white text-center py-2">
    &copy; 2025 Aplikasi RSA SPA
  </footer>

  <script>
    const app = document.getElementById('app');

    const user = JSON.parse(localStorage.getItem('currentUser'));
    if (!user) {
      window.location.href = 'login.html';
    }

    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('currentUser');
      window.location.href = 'login.html';
    });

    app.innerHTML = `
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-semibold mb-4">Halo, ${user.username}</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block mb-1">Teks:</label>
            <textarea id="inputText" class="w-full border rounded p-2" rows="3" placeholder="Tulis pesan atau tanda tangan"></textarea>
            <label class="block mt-4 mb-1">Atau pilih file (hanya nama file yang diambil):</label>
            <input type="file" id="fileInput" class="w-full border rounded p-2" />
          </div>
          <div>
            <label class="block mb-1">p (prima):</label>
            <input type="number" id="p" class="w-full border rounded p-2" placeholder="contoh: 11" />
            <label class="block mt-4 mb-1">q (prima):</label>
            <input type="number" id="q" class="w-full border rounded p-2" placeholder="contoh: 13" />
            <label class="block mt-4 mb-1">e (relatif prima dg phi):</label>
            <input type="number" id="e" class="w-full border rounded p-2" placeholder="contoh: 7" />
          </div>
        </div>
        <div class="mt-4 flex gap-4">
          <button id="encryptBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
            <i class="fas fa-lock mr-1"></i> ENKRIPSI
          </button>
          <button id="decryptBtn" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
            <i class="fas fa-unlock mr-1"></i> DEKRIPSI
          </button>
        </div>
        <div class="mt-4">
          <label class="block mb-1">Hasil:</label>
          <textarea id="output" class="w-full border rounded p-2 bg-gray-100" rows="3" readonly></textarea>
        </div>
      </div>
    `;

    function isPrime(n) {
      if (n <= 1) return false;
      for (let i = 2; i <= Math.sqrt(n); i++) {
        if (n % i === 0) return false;
      }
      return true;
    }

    function gcd(a, b) {
      return b === 0 ? a : gcd(b, a % b);
    }

    function modPow(base, exp, mod) {
      base = BigInt(base);
      exp = BigInt(exp);
      mod = BigInt(mod);
      let result = BigInt(1);
      while (exp > 0) {
        if (exp % BigInt(2) === BigInt(1)) {
          result = (result * base) % mod;
        }
        base = (base * base) % mod;
        exp = exp / BigInt(2);
      }
      return result;
    }

    function modInverse(a, m) {
      a = BigInt(a); m = BigInt(m);
      let m0 = m, x0 = BigInt(0), x1 = BigInt(1);
      while (a > 1) {
        let q = a / m;
        [a, m] = [m, a % m];
        [x0, x1] = [x1 - q * x0, x0];
      }
      return x1 < 0 ? x1 + m0 : x1;
    }

    function blockToNumber(text) {
      let result = '';
      for (let i = 0; i < text.length; i++) {
        result += text.charCodeAt(i).toString().padStart(3, '0');
      }
      return BigInt(result);
    }

    function numberToBlock(number) {
      const numStr = number.toString().padStart(Math.ceil(number.toString().length / 3) * 3, '0');
      let result = '';
      for (let i = 0; i < numStr.length; i += 3) {
        result += String.fromCharCode(parseInt(numStr.substring(i, i + 3)));
      }
      return result;
    }

    function generateRSAKey(p, q, e) {
      if (!isPrime(p) || !isPrime(q)) {
        alert('p dan q harus bilangan prima!');
        return null;
      }
      const n = p * q;
      const phi = (p - 1) * (q - 1);
      if (e <= 1 || e >= phi || gcd(e, phi) !== 1) {
        alert('e harus koprima dengan phi.');
        return null;
      }
      const d = modInverse(e, phi);
      return { n, e, d };
    }

    document.getElementById('encryptBtn').addEventListener('click', () => {
      const p = parseInt(document.getElementById('p').value);
      const q = parseInt(document.getElementById('q').value);
      const e = parseInt(document.getElementById('e').value);
      const key = generateRSAKey(p, q, e);
      if (!key) return;

      let text = document.getElementById('inputText').value.trim();
      if (!text && document.getElementById('fileInput').files.length > 0) {
        text = document.getElementById('fileInput').files[0].name;
      }
      if (!text) {
        alert('Tulis teks atau pilih file.');
        return;
      }

      const encrypted = modPow(blockToNumber(text), key.e, key.n);
      document.getElementById('output').value = encrypted.toString();

      // Simpan kunci privat untuk dekripsi
      localStorage.setItem('rsaPrivateKey', JSON.stringify({ d: key.d.toString(), n: key.n.toString() }));
    });

    document.getElementById('decryptBtn').addEventListener('click', () => {
      const cipherText = document.getElementById('output').value.trim();
      if (!cipherText) {
        alert('Belum ada hasil enkripsi.');
        return;
      }
      const privateKey = JSON.parse(localStorage.getItem('rsaPrivateKey'));
      if (!privateKey) {
        alert('Kunci privat tidak ditemukan.');
        return;
      }
      const decrypted = modPow(BigInt(cipherText), BigInt(privateKey.d), BigInt(privateKey.n));
      const result = numberToBlock(decrypted);
      alert('Hasil Dekripsi:\n' + result);
    });
  </script>
</body>
</html>
